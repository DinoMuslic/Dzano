<!-- Bootstrap DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<div class="container mt-4">
  <h3>User Management</h3>

  <!-- User Table -->
  <table id="usersTable" class="table table-striped table-bordered table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Email</th>
        <th>Country ID</th>
        <th>Bio</th>
        <th>Created At</th>
        <th>Balance</th>
        <th>Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>Edit User</h5></div>
      <div class="modal-body">
        <input type="hidden" id="editUserId">
        <input type="text" id="editFirstName" class="form-control mb-2" placeholder="First Name">
        <input type="text" id="editLastName" class="form-control mb-2" placeholder="Last Name">
        <input type="email" id="editEmail" class="form-control mb-2" placeholder="Email">
        <input type="number" id="editCountryId" class="form-control mb-2" placeholder="Country ID">
        <textarea id="editBio" class="form-control mb-2" placeholder="Bio"></textarea>
        <input type="number" id="editBalance" class="form-control mb-2" placeholder="Balance" step="0.01">
        <select id="editRole" class="form-control mb-2">
          <option value="0">User</option>
          <option value="1">Admin</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="saveUserChangesBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirm Delete</h5>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this user?
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
const API_BASE = get_base_url();

let table;
let selectedUserId = null;

$(document).ready(function () {
  // Initialize DataTable
  table = $('#usersTable').DataTable({
    ajax: {
      url: `${API_BASE}/users/`,
      dataSrc: ''
    },
    columns: [
      { data: 'id' },
      { data: 'first_name' },
      { data: 'last_name' },
      { data: 'email' },
      { data: 'country_id' },
      { data: 'bio' },
      { data: 'created_at' },
      { data: 'balance' },
      {
        data: 'isAdmin',
        render: val => val == 1 ? 'Admin' : 'User'
      },
      {
        data: null,
        render: data => `
          <div class="btn-group btn-group-sm" role="group">
        <button class="btn btn-warning editUserBtn" data-id="${data.id}">Edit</button>
        <button class="btn btn-danger deleteUserBtn" data-id="${data.id}">Delete</button>
         </div>`
      }
    ]
  });

const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));

$('#usersTable tbody').on('click', '.editUserBtn', function () {
  const data = table.row($(this).parents('tr')).data();
  $('#editUserId').val(data.id);
  $('#editFirstName').val(data.first_name);
  $('#editLastName').val(data.last_name);
  $('#editEmail').val(data.email);
  $('#editCountryId').val(data.country_id);
  $('#editBio').val(data.bio);
  $('#editBalance').val(data.balance);
  $('#editRole').val(data.isAdmin);
  editModal.show();
});

$('#saveUserChangesBtn').click(function () {
  const updatedUser = {
    id: $('#editUserId').val(),
    first_name: $('#editFirstName').val(),
    last_name: $('#editLastName').val(),
    email: $('#editEmail').val(),
    country_id: $('#editCountryId').val(),
    bio: $('#editBio').val(),
    balance: $('#editBalance').val(),
    isAdmin: $('#editRole').val()
  };

  $.post(`${API_BASE}/users/update`, updatedUser, function () {
    editModal.hide();
    table.ajax.reload(null, false);
    toastr.success('User was edited successfully.');
  }).fail(() => {
    toastr.error('Failed to update user.');
  });
});

  // Handle Delete Button
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));

  $('#usersTable tbody').on('click', '.deleteUserBtn', function () {
    selectedUserId = $(this).data('id');
    deleteModal.show();

  });

  // Confirm Delete
  $('#confirmDeleteBtn').click(function () {
    $.ajax({
      url: `${API_BASE}/users/delete/${selectedUserId}`,
      type: 'DELETE',
      success: function () {
        deleteModal.hide();
        table.ajax.reload(null, false); 
        toastr.success('User was successfully deleted.');
      },
      error: function () {
        alert('Failed to delete user.');
      }
    });
  });
});
</script>
